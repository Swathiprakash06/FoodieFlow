<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>Checkout</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<div class="navbar">
    <div class="nav-left">
        <h2>üçî FoodieFlow</h2>
    </div>
    <div class="nav-right">
        <button onclick="history.back()" class="btn-icon-text">
            Back
        </button>
    </div>
</div>
<div class="container main-layout">
    <div class="content-area">
        <h1>Checkout</h1>

        <div class="card card-body" style="margin-bottom: 25px;">
            <h3>Delivery Address</h3>
            <form id="address-form">
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                      <div class="form-group" style="flex: 1;">
                        <label>Apartment/Door No </label>
                        <input type="text" id="apartment" placeholder="Apt 4B">
                    </div>
                    <div class="form-group" style="flex: 1.5;">
                        <label>Street Address</label>
                        <input type="text" id="street" placeholder="123 Main Street" required>
                    </div>
                  
                </div>

                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>City</label>
                        <input type="text" id="city" placeholder="Metropolis" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Zip Code</label>
                        <input type="text" id="zip" placeholder="902104" required>
                    </div>
                </div>
            </form>
        </div>

        <div class="card card-body">
            <h3>Order Summary</h3>
            <div class="summary-container">
                {% for ci in cart_items %}
                <div class="summary-line">
                    <span class="text-muted">{{ ci.item.name }}</span>
                    <span class="price" style="font-size: 1rem;">‚Çπ{{ ci.item.price }}</span>
                </div>
                {% endfor %}

                <div class="summary-line total" style="border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px;">
                    <span>Total Amount</span>
                    <span>‚Çπ{{ total_price }}</span>
                </div>
            </div>

            <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <button id="rzp-button" class="btn-nav-primary full-width" style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V10h16v8zm0-10H4V6h16v2z"/></svg>
                    Pay with Razorpay
                </button>
            </div>
        </div>
    </div>
</div>
{% if messages %}
  {% for message in messages %}
    <div class="alert {{ message.tags }}">
        {{ message }}
    </div>
  {% endfor %}
{% endif %}
<script>
setTimeout(() => {
    document.querySelectorAll('.alert').forEach(t => {
        t.style.opacity = '0';
        setTimeout(() => t.remove(), 400);
    });
}, 3000);

    const streetInput = document.getElementById('street');
    const apartmentInput = document.getElementById('apartment'); // Added this
    const cityInput = document.getElementById('city');
    const zipInput = document.getElementById('zip');
    const payButton = document.getElementById("rzp-button");

    // 2. Validation function
    function validateCheckout() {
        // We only "require" Street, City, and Zip. Apartment remains optional.
        const isRequiredFieldsFilled = streetInput.value.trim() && 
                                       cityInput.value.trim() && 
                                       zipInput.value.trim();

        if (isRequiredFieldsFilled) {
            payButton.disabled = false;
            payButton.style.opacity = "1";
            payButton.style.cursor = "pointer";
        } else {
            payButton.disabled = true;
            payButton.style.opacity = "0.6";
            payButton.style.cursor = "not-allowed";
        }
    }

    // 3. Listen for typing in all fields
    // (Even though apartment is optional, listening to it ensures a smooth UI)
    [streetInput, apartmentInput, cityInput, zipInput].forEach(el => {
        el.addEventListener('input', validateCheckout);
    });

    // Run once on page load
    validateCheckout();

    // 4. Razorpay Integration
    var options = {
        key: "{{ razorpay_key_id }}",
        amount: "{{ amount }}",
        currency: "INR",
        name: "FoodieFlow",
        order_id: "{{ order_id }}",
        handler: function (response) {
            window.location.href = "{% url 'orders' username=username %}";
        },
        prefill: {
            name: "{{ username }}",
            // You can pass the address data here if needed for Razorpay records
            notes: {
                address: streetInput.value,
                apt: apartmentInput.value,
                city: cityInput.value
            }
        },
        theme: { color: "#2ecc71" }
    };

    var rzp = new Razorpay(options);

    payButton.onclick = function (e) {
        if(!payButton.disabled) {
            rzp.open();
        }
        e.preventDefault();
    };
</script>

</body>
</html>

